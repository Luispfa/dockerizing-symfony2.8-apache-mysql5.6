// Generated by CoffeeScript 1.7.1
(function() {
  'use strict';
  angular.module('app.localization', []).factory('localize', [
    '$http', '$rootScope', '$window', function($http, $rootScope, $window) {
      var localize;
      localize = {
        language: '',
        url: void 0,
        resourceFileLoaded: false,
        successCallback: function(data) {
          localize.dictionary = data;
          localize.resourceFileLoaded = true;
          return $rootScope.$broadcast('localizeResourcesUpdated');
        },
        setLanguage: function(value) {
          localize.language = value.toLowerCase().split("-")[0];
          return localize.initLocalizedResources();
        },
        getLanguage: function() {
           return  localize.language;
        },
        getLanguageText: function() {
            var lang = 'Espanol';
            switch (localize.language) {
                case 'en':
                  lang = 'English';
                  break;
                case 'es':
                  lang = 'Espanol';
                  break;
                case 'ca':
                  lang = 'Catalan';
                  break;
                case 'gl':
                  lang = 'Gallego';
                  break;
              }
              return lang;
        },
        setUrl: function(value) {
          localize.url = value;
          return localize.initLocalizedResources();
        },
        buildUrl: function() {
          if (!localize.language) {
            localize.language = ($window.navigator.userLanguage || $window.navigator.language).toLowerCase();
            localize.language = localize.language.split("-")[0];
          }
          return WebDefault + '/' + NameController + '/i18n/resources-locale_' + localize.language + '.js';
        },
        initLocalizedResources: function() {
          var url;
          url = localize.url || localize.buildUrl();
          return $http({
            method: "GET",
            url: url,
            cache: false
          }).success(localize.successCallback).error(function() {
            return $rootScope.$broadcast('localizeResourcesUpdated');
          });
        },
        parseParameters: function(value, parameters){
          if(parameters === undefined) return value;

          for(var i in parameters){
            value = value.replace("%%" + i + "%%", this.getLocalizedString(parameters[i]));
          }
          return value;
        },
        getLocalizedString: function(value,parametersI18n) {
          var result, valueLowerCase;
          result = void 0;
          if (localize.dictionary && value) {
            valueLowerCase = value.toLowerCase();
            if (localize.dictionary[valueLowerCase] === '' || localize.dictionary[valueLowerCase] === undefined) {
              result = value;
            } else {
              result = localize.dictionary[valueLowerCase];
            }
          } else {
            result = value;
          }
          result = localize.parseParameters(result,parametersI18n);
          return result;
        }
      };
      return localize;
    }
  ]).directive('i18n', [
    'localize', function(localize) {
      var i18nDirective;
      i18nDirective = {
        restrict: "EA",
        scope: {
          parametersI18n: '='
        },
        updateText: function(ele, input, placeholder, value, translateValues, parametersI18n) {
          var result;
          result = void 0;
          var tValues = null;
          if (typeof translateValues != "undefined") {
              tValues = JSON.parse(JSON.stringify(eval("(" + translateValues + ")")));
          }
          if (input === 'i18n-placeholder') {
            result = localize.getLocalizedString(placeholder);
          } 
          else if (input === 'i18n-value') {
            result = localize.getLocalizedString(value);
          }
          else if (input.length >= 1) {
            result = localize.getLocalizedString(input,parametersI18n);
          }
          for (var translateKey in tValues)
          {
              result = result.replace("{" + translateKey + "}", tValues[translateKey]);
          }
          
          if (input === 'i18n-placeholder') {
            return ele.attr('placeholder', result);
          } 
          else if (input === 'i18n-value') {
            return ele.attr('value', result);
          }
          else if (input.length >= 1) {
            return ele.html(result);
          }
        },
        compile: function(tElement, tAttrs, transclude){
          return {
            pre: function(scope, ele, attrs) {
              scope.$on('localizeResourcesUpdated', function() {
                return i18nDirective.updateText(ele, attrs.i18n, attrs.placeholder, attrs.value, attrs.translateValues,scope.parametersI18n);
              });
              return attrs.$observe('i18n', function(value) {
                return i18nDirective.updateText(ele, value, attrs.placeholder, attrs.value, attrs.translateValues,scope.parametersI18n);
              });
            }
          }
        } 
      };
      return i18nDirective;
    }
  ]).controller('LangCtrl', [
    '$scope', 'localize', function($scope, localize) {
      //$scope.lang = 'Espanol';
      $scope.lang = localize.getLanguageText();

      var flags = {
        'Espanol': "language_spanish",
        'Catalan': "language_catalan",
        'English': "language_english",
        'Gallego': "language_gaelican"
      };

      $scope.setLang = function(lang) {
        switch (lang) {
          case 'English':
            localize.setLanguage('EN-US');
            break;
          case 'Espanol':
            localize.setLanguage('ES-ES');
            break;
          case 'Catalan':
            localize.setLanguage('CA-CA');
            break;
          case 'Gallego':
            localize.setLanguage('GA-GA');
            break;
        }
        return $scope.lang = lang;
      };

      return $scope.getFlag = function() {
        return localize.getLocalizedString(flags[$scope.lang]);
      };
    }
  ]);

}).call(this);
